<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система управления складскими остатками</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .nav-tabs .nav-link.active {
            font-weight: bold;
            background-color: #f8f9fa;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .error-message {
            color: #dc3545;
            font-weight: bold;
        }
        .success-message {
            color: #198754;
            font-weight: bold;
        }
        .form-control:invalid {
            border-color: #dc3545;
        }
        .form-control:invalid:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        .form-control:valid {
            border-color: #198754;
        }
        .form-control:valid:focus {
            border-color: #198754;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="text-center mb-4">Система управления складскими остатками</h1>
        
        <ul class="nav nav-tabs mb-4" id="mainTabs">
            <li class="nav-item">
                <a class="nav-link active" href="#nomenclature" data-bs-toggle="tab">Товары</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#suppliers" data-bs-toggle="tab">Поставщики</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#storages" data-bs-toggle="tab">Склады</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#leftovers" data-bs-toggle="tab">Остатки на складах</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#products-suppliers" data-bs-toggle="tab">Товары и поставщики</a>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="nomenclature">
                <div class="d-flex justify-content-between mb-3">
                    <h3>Список товаров</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                        Добавить товар
                    </button>
                </div>
                
                <div class="card p-3 mb-3">
                    <h5>Фильтр по поставщику</h5>
                    <div class="d-flex align-items-center">
                        <select class="form-select w-auto me-3" id="supplierFilterSelect">
                            <option value="all">Показать все товары</option>
                            </select>
                        <button class="btn btn-secondary" onclick="document.getElementById('supplierFilterSelect').value = 'all'; loadProducts()">Сбросить</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table table-striped" id="productsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Артикул</th>
                                <th>Название</th>
                                <th>Описание</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="suppliers">
                <div class="d-flex justify-content-between mb-3">
                    <h3>Поставщики</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSupplierModal">
                        Добавить поставщика
                    </button>
                </div>
                <div class="table-container">
                    <table class="table table-striped" id="suppliersTable">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Название</th>
                                <th>Email</th>
                                <th>Телефон</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="suppliersTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="storages">
                <div class="d-flex justify-content-between mb-3">
                    <h3>Склады</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStorageModal">
                        Добавить склад
                    </button>
                </div>
                <div class="table-container">
                    <table class="table table-striped" id="storagesTable">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Название</th>
                                <th>Адрес</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="storagesTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="leftovers">
                
                <div class="card p-3 mb-4">
                    <h4>Добавить закупку (Поступление на Склад)</h4>
                    <form id="addPurchaseForm">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Товар</label>
                                <select class="form-select" id="purchaseProduct" required>
                                    <option value="">Выберите товар</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Склад</label>
                                <select class="form-select" id="purchaseStorage" required>
                                    <option value="">Выберите склад</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Количество</label>
                                <input type="number" class="form-control" id="purchaseQuantity" min="1" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Добавить закупку</button>
                    </form>
                </div>
                
                <div class="d-flex justify-content-between mb-3 align-items-center">
                    <h3>Остатки на складах</h3>
                    <div>
                        <input type="number" class="form-control w-auto d-inline-block" id="deficitFilter" placeholder="Дефицит < N" min="1">
                        <button class="btn btn-primary" onclick="loadLeftovers()">Применить фильтр</button>
                        <button class="btn btn-secondary" onclick="resetDeficitFilter()">Сбросить фильтр</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table table-striped" id="leftoversTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Артикул</th>
                                <th>Название товара</th>
                                <th>Склад</th>
                                <th>Остаток</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="leftoversTableBody">
                            </tbody>
                    </table>
                </div>

                <div class="modal fade" id="editLeftoverModal" tabindex="-1" aria-labelledby="editLeftoverModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form id="editLeftoverForm">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editLeftoverModalLabel">Изменить остаток на складе</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Товар (ID)</label>
                                        <input type="text" class="form-control" id="editLeftoverProductId" disabled>
                                        <input type="hidden" id="editLeftoverOriginalProductId">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Склад (ID)</label>
                                        <input type="text" class="form-control" id="editLeftoverStorageId" disabled>
                                        <input type="hidden" id="editLeftoverOriginalStorageId">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Остаток</label>
                                        <input type="number" class="form-control" id="editLeftoverQuantity" min="0" required>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                    <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="products-suppliers">
                <h3>Товары и поставщики</h3>
                <div class="card p-3 mb-4">
                    <h4>Добавить поставку (Связь Товар-Поставщик)</h4>
                    <form id="addSupplyForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Товар</label>
                                <select class="form-select" id="supplyProduct" required>
                                    <option value="">Выберите товар</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Поставщик</label>
                                <select class="form-select" id="supplySupplierSelect" required>
                                    <option value="">Выберите поставщика</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Добавить поставку</button>
                    </form>
                </div>
                
                <div class="table-container">
                    <table class="table table-striped" id="productsSuppliersTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Название Товара</th>
                                <th>Название Поставщика</th>
                                <th>Телефон</th>
                                <th>Email</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="productsSuppliersTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addProductForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addProductModalLabel">Добавить новый товар</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="productName" class="form-label">Название товара</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="mb-3">
                            <label for="productDescription" class="form-label">Описание</label>
                            <textarea class="form-control" id="productDescription"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-primary">Добавить товар</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editProductForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editProductModalLabel">Изменить товар</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editProductId">
                        <div class="mb-3">
                            <label class="form-label">Артикул</label>
                            <input type="text" class="form-control" id="editProductArticle" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Название товара</label>
                            <input type="text" class="form-control" id="editProductName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" id="editProductDescription"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addSupplierForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addSupplierModalLabel">Добавить нового поставщика</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="supplierName" class="form-label">Название поставщика</label>
                            <input type="text" class="form-control" id="supplierName" required>
                        </div>
                        <div class="mb-3">
                            <label for="supplierEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="supplierEmail">
                        </div>
                        <div class="mb-3">
                            <label for="supplierPhone" class="form-label">Телефон</label>
                            <input type="tel" class="form-control" id="supplierPhone" 
                                   pattern="\+7\(\d{3}\)\d{3}-\d{2}-\d{2}" 
                                   placeholder="+7(123)456-78-90" 
                                   title="Номер телефона должен быть в формате: +7(XXX)XXX-XX-XX" required>
                            <div class="form-text">Формат: +7(XXX)XXX-XX-XX</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-primary">Добавить поставщика</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editSupplierModal" tabindex="-1" aria-labelledby="editSupplierModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editSupplierForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editSupplierModalLabel">Изменить информацию о поставщике</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editSupplierId">
                        <div class="mb-3">
                            <label class="form-label">ID</label>
                            <input type="text" class="form-control" id="editSupplierDisplayId" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Название поставщика</label>
                            <input type="text" class="form-control" id="editSupplierName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="editSupplierEmail">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Телефон</label>
                            <input type="tel" class="form-control" id="editSupplierPhone" 
                                   pattern="\+7\(\d{3}\)\d{3}-\d{2}-\d{2}"
                                   title="Номер телефона должен быть в формате: +7(XXX)XXX-XX-XX" required>
                            <div class="form-text">Формат: +7(XXX)XXX-XX-XX</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addStorageModal" tabindex="-1" aria-labelledby="addStorageModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addStorageForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addStorageModalLabel">Добавить новый склад</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="storageName" class="form-label">Название склада</label>
                            <input type="text" class="form-control" id="storageName" required>
                        </div>
                        <div class="mb-3">
                            <label for="storageAddress" class="form-label">Адрес</label>
                            <textarea class="form-control" id="storageAddress"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-primary">Добавить склад</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editStorageModal" tabindex="-1" aria-labelledby="editStorageModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editStorageForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editStorageModalLabel">Изменить информацию о складе</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editStorageId">
                        <div class="mb-3">
                            <label class="form-label">ID</label>
                            <input type="text" class="form-control" id="editStorageDisplayId" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Название склада</label>
                            <input type="text" class="form-control" id="editStorageName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Адрес</label>
                            <textarea class="form-control" id="editStorageAddress"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <div id="messageArea" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = '';
        let allProducts = [];
        let allSuppliers = [];
        let allStorages = [];

        // ИЗМЕНЕНИЕ 1: Артикул (ID товара) - дополнить нулями до 8 символов
        function formatArticle(id) {
            return String(id).padStart(8, '0');
        }

        // ИЗМЕНЕНИЕ 2: ID Поставщика - вернуть как есть (целое число)
        function formatSupplierId(id) {
            return parseInt(id); // Гарантируем числовой формат
        }

        // --- Helper functions ---
        
        // Обработка ответов API
        async function handleResponse(response, defaultErrorMsg) {
            if (!response.ok) {
                let errorMessage = defaultErrorMsg || 'Произошла неизвестная ошибка при выполнении запроса.';
                try {
                    const errorData = await response.json();
                    if (errorData.detail) {
                        if (Array.isArray(errorData.detail) && errorData.detail[0].loc) {
                            // Ошибка валидации Pydantic
                            const fieldName = errorData.detail[0].loc[1];
                            let errorMsg = errorData.detail[0].msg;
                            
                            // Перевод стандартных ошибок Pydantic на русский
                            if (errorMsg.includes('valid email address')) {
                                errorMsg = 'Некорректный формат email адреса';
                            }
                            
                            errorMessage = `Ошибка валидации поля "${fieldName}": ${errorMsg}`;
                        } else if (typeof errorData.detail === 'string') {
                            // Стандартный HTTPException detail
                            errorMessage = errorData.detail;
                        }
                    }
                } catch (e) {
                    // Игнорируем ошибки парсинга, используем сообщение по умолчанию
                }
                throw new Error(errorMessage);
            }
            // Если ответ ОК, возвращаем его JSON
            return response.json();
        }

        // Сброс фильтра дефицита
        function resetDeficitFilter() {
            document.getElementById('deficitFilter').value = '';
            loadLeftovers();
        }

        // Показать сообщение
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
            
            messageArea.prepend(alertDiv);

            setTimeout(() => {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                bsAlert.close();
            }, 5000);
        }

        // --- Loading and Rendering Functions ---

        async function loadProducts() {
            try {
                const supplierId = document.getElementById('supplierFilterSelect').value;
                let url = `${API_BASE_URL}/product`;
                if (supplierId && supplierId !== 'all') {
                    // ИСПРАВЛЕНИЕ: отправляем числовой ID без ведущих нулей
                    const numericSupplierId = parseInt(supplierId);
                    url = `${API_BASE_URL}/supplier/supplied_products?supplier_id=${numericSupplierId}`;
                }
                const response = await fetch(url);
                allProducts = await handleResponse(response, 'Ошибка загрузки товаров');
                renderProductsTable(allProducts);
            } catch (error) {
                console.error('Ошибка загрузки товаров:', error);
                showMessage(`Не удалось загрузить товары: ${error.message}`, 'error');
            }
        }

        function renderProductsTable(data) {
            const tableBody = document.getElementById('productsTableBody');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Нет товаров для отображения.</td></tr>';
                return;
            }

            data.forEach(product => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = formatArticle(product.product_id);
                row.insertCell().textContent = product.product_name;
                row.insertCell().textContent = product.product_description || '';
                
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn btn-sm btn-outline-info me-2" onclick="openEditProductModal(${product.product_id})">
                        Изменить
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.product_id}, '${product.product_name}')">
                        Удалить
                    </button>
                `;
            });
        }

        async function loadSuppliers() {
            try {
                const response = await fetch(`${API_BASE_URL}/supplier`);
                allSuppliers = await handleResponse(response, 'Ошибка загрузки поставщиков');
                renderSuppliersTable(allSuppliers);
            } catch (error) {
                console.error('Ошибка загрузки поставщиков:', error);
                showMessage(`Не удалось загрузить поставщиков: ${error.message}`, 'error');
            }
        }

        function renderSuppliersTable(data) {
            const tableBody = document.getElementById('suppliersTableBody');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Нет поставщиков для отображения.</td></tr>';
                return;
            }

            data.forEach(supplier => {
                const row = tableBody.insertRow();
                // ИСПРАВЛЕНИЕ: используем числовой ID без форматирования
                row.insertCell().textContent = supplier.supplier_id; // Просто числовой ID
                row.insertCell().textContent = supplier.supplier_name;
                row.insertCell().textContent = supplier.email || '';
                row.insertCell().textContent = supplier.phone;
                
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn btn-sm btn-outline-info me-2" onclick="openEditSupplierModal(${supplier.supplier_id})">
                        Изменить
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSupplier(${supplier.supplier_id}, '${supplier.supplier_name}')">
                        Удалить
                    </button>
                `;
            });
        }

        async function loadStorages() {
            try {
                const response = await fetch(`${API_BASE_URL}/storage`);
                allStorages = await handleResponse(response, 'Ошибка загрузки складов');
                renderStoragesTable(allStorages);
            } catch (error) {
                console.error('Ошибка загрузки складов:', error);
                showMessage(`Не удалось загрузить склады: ${error.message}`, 'error');
            }
        }

        function renderStoragesTable(data) {
            const tableBody = document.getElementById('storagesTableBody');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Нет складов для отображения.</td></tr>';
                return;
            }

            data.forEach(storage => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = storage.storage_id;
                row.insertCell().textContent = storage.storage_name;
                row.insertCell().textContent = storage.address || '';
                
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn btn-sm btn-outline-info me-2" onclick="openEditStorageModal(${storage.storage_id})">
                        Изменить
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteStorage(${storage.storage_id}, '${storage.storage_name}')">
                        Удалить
                    </button>
                `;
            });
        }

        async function loadLeftovers() {
            try {
                const deficitValue = document.getElementById('deficitFilter').value;
                let url = `${API_BASE_URL}/storage/leftovers`;
                if (deficitValue && !isNaN(parseInt(deficitValue)) && parseInt(deficitValue) >= 1) {
                    url += `?num=${parseInt(deficitValue)}`;
                }
                
                const response = await fetch(url);
                const leftovers = await handleResponse(response, 'Ошибка загрузки остатков');
                renderLeftoversTable(leftovers);
            } catch (error) {
                console.error('Ошибка загрузки остатков:', error);
                showMessage(`Не удалось загрузить остатки: ${error.message}`, 'error');
            }
        }

        function renderLeftoversTable(data) {
            const tableBody = document.getElementById('leftoversTableBody');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Нет остатков для отображения.</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = formatArticle(item.product_id);
                row.insertCell().textContent = item.product_name;
                row.insertCell().textContent = item.storage_name;
                const leftoverCell = row.insertCell();
                leftoverCell.textContent = item.leftover;
                if (item.leftover === 0) {
                    leftoverCell.classList.add('text-danger', 'fw-bold');
                }
                
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn btn-sm btn-outline-info me-2" 
                            onclick="openEditLeftoverModal(${item.product_id}, ${item.storage_id}, ${item.leftover})">
                        Изменить
                    </button>
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="deleteLeftover(${item.product_id}, ${item.storage_id}, '${item.product_name}')">
                        Удалить
                    </button>
                `;
            });
        }

        async function loadProductsWithSuppliers() {
            try {
                const response = await fetch(`${API_BASE_URL}/supplier/with_products`);
                const data = await handleResponse(response, 'Ошибка загрузки связей "Товар - Поставщик"');
                renderProductsWithSuppliersTable(data);
            } catch (error) {
                console.error('Ошибка загрузки связей "Товар - Поставщик":', error);
                showMessage(`Не удалось загрузить связи "Товар - Поставщик": ${error.message}`, 'error');
            }
        }

        function renderProductsWithSuppliersTable(data) {
            const tableBody = document.getElementById('productsSuppliersTableBody');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Нет зарегистрированных связей "Товар - Поставщик".</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = tableBody.insertRow();
                
                row.insertCell().textContent = item.product_name; 
                row.insertCell().textContent = item.supplier_name; 
                row.insertCell().textContent = item.phone || '-';
                row.insertCell().innerHTML = item.email ? `<a href="mailto:${item.email}">${item.email}</a>` : '-';
                
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="deleteSupply(${item.product_id}, ${item.supplier_id}, '${item.product_name}', '${item.supplier_name}')">
                        Удалить поставку
                    </button>
                `;
            });
        }

        async function populateDropdowns() {
            const purchaseProductSelect = document.getElementById('purchaseProduct');
            const supplyProductSelect = document.getElementById('supplyProduct');
            const supplySupplierSelect = document.getElementById('supplySupplierSelect');
            const supplierFilterSelect = document.getElementById('supplierFilterSelect');
            
            // Очистка перед заполнением
            purchaseProductSelect.innerHTML = '<option value="">Выберите товар</option>';
            supplyProductSelect.innerHTML = '<option value="">Выберите товар</option>';
            supplySupplierSelect.innerHTML = '<option value="">Выберите поставщика</option>';
            supplierFilterSelect.innerHTML = '<option value="all">Показать все товары</option>';

            try {
                const [productsResponse, suppliersResponse, storagesResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/product`),
                    fetch(`${API_BASE_URL}/supplier`),
                    fetch(`${API_BASE_URL}/storage`),
                ]);

                allProducts = await handleResponse(productsResponse, 'Ошибка загрузки товаров для выпадающего списка');
                const suppliers = await handleResponse(suppliersResponse, 'Ошибка загрузки поставщиков для выпадающего списка');
                const storages = await handleResponse(storagesResponse, 'Ошибка загрузки складов для выпадающего списка');
                
                allProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.product_id;
                    option.textContent = product.product_name;
                    supplyProductSelect.appendChild(option.cloneNode(true));
                    purchaseProductSelect.appendChild(option.cloneNode(true)); 
                });
                
                suppliers.forEach(supplier => {
                    let optionSupply = document.createElement('option');
                    optionSupply.value = supplier.supplier_id;
                    optionSupply.textContent = supplier.supplier_name;
                    supplySupplierSelect.appendChild(optionSupply.cloneNode(true));

                    let optionFilter = document.createElement('option');
                    optionFilter.value = supplier.supplier_id;
                    optionFilter.textContent = supplier.supplier_name;
                    supplierFilterSelect.appendChild(optionFilter);
                });

                // Для закупок
                const purchaseStorageSelect = document.getElementById('purchaseStorage');
                
                purchaseStorageSelect.innerHTML = '<option value="">Выберите склад</option>';
                
                storages.forEach(storage => {
                    const option = document.createElement('option');
                    option.value = storage.storage_id;
                    option.textContent = storage.storage_name;
                    purchaseStorageSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Ошибка заполнения выпадающих списков:', error);
                showMessage(`Не удалось загрузить данные для выпадающих списков: ${error.message}`, 'error');
            }
        }

        // --- CRUD Actions ---

        // Продукты
        document.getElementById('addProductForm').addEventListener('submit', addProduct);
        document.getElementById('editProductForm').addEventListener('submit', editProduct);
        
        async function addProduct(event) {
            event.preventDefault();
            const productData = {
                product_name: document.getElementById('productName').value,
                product_description: document.getElementById('productDescription').value,
            };

            try {
                const response = await fetch(`${API_BASE_URL}/product`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData),
                });
                const result = await handleResponse(response, 'Ошибка добавления товара');
                showMessage(`Товар "${productData.product_name}" успешно добавлен с артикулом ${formatArticle(result.id)}!`, 'success');
                
                // Сброс формы и закрытие модального окна
                document.getElementById('addProductForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();

                await Promise.all([loadProducts(), populateDropdowns(), loadProductsWithSuppliers()]);
            } catch (error) {
                console.error('Ошибка добавления товара:', error);
                showMessage(`Ошибка добавления товара: ${error.message}`, 'error');
            }
        }
        
        function openEditProductModal(productId) {
            const product = allProducts.find(p => p.product_id === productId);
            if (!product) return showMessage('Товар не найден.', 'error');

            document.getElementById('editProductId').value = product.product_id;
            document.getElementById('editProductArticle').value = formatArticle(product.product_id);
            document.getElementById('editProductName').value = product.product_name;
            document.getElementById('editProductDescription').value = product.product_description || '';

            const editModal = new bootstrap.Modal(document.getElementById('editProductModal'));
            editModal.show();
        }

        async function editProduct(event) {
            event.preventDefault();
            const productData = {
                product_id: parseInt(document.getElementById('editProductId').value),
                product_name: document.getElementById('editProductName').value,
                product_description: document.getElementById('editProductDescription').value,
            };

            try {
                const response = await fetch(`${API_BASE_URL}/product`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData),
                });
                await handleResponse(response, 'Ошибка изменения товара');
                showMessage(`Товар "${productData.product_name}" успешно изменен!`, 'success');
                
                bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                await Promise.all([loadProducts(), populateDropdowns(), loadProductsWithSuppliers(), loadLeftovers()]);
            } catch (error) {
                console.error('Ошибка изменения товара:', error);
                showMessage(`Ошибка изменения товара: ${error.message}`, 'error');
            }
        }

        async function deleteProduct(id, name) {
            if (!confirm(`Вы уверены, что хотите удалить товар "${name}" (Артикул: ${formatArticle(id)})?`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/product?id=${id}`, {
                    method: 'DELETE'
                });
                await handleResponse(response, 'Ошибка удаления товара');
                showMessage('Товар успешно удален!', 'success');
                await Promise.all([loadProducts(), populateDropdowns(), loadProductsWithSuppliers(), loadLeftovers()]);
            } catch (error) {
                console.error('Ошибка удаления товара:', error);
                showMessage(`Ошибка удаления товара: ${error.message}`, 'error');
            }
        }

        // Поставщики
        document.getElementById('addSupplierForm').addEventListener('submit', addSupplier);
        document.getElementById('editSupplierForm').addEventListener('submit', editSupplier);

        async function addSupplier(event) {
            event.preventDefault();
            const supplierData = {
                supplier_name: document.getElementById('supplierName').value,
                email: document.getElementById('supplierEmail').value || null,
                phone: document.getElementById('supplierPhone').value,
            };

            try {
                const response = await fetch(`${API_BASE_URL}/supplier`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(supplierData),
                });
                const result = await handleResponse(response, 'Ошибка добавления поставщика');
                showMessage(`Поставщик "${supplierData.supplier_name}" успешно добавлен! (ID: ${result.id})`, 'success');
                
                document.getElementById('addSupplierForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addSupplierModal')).hide();

                await Promise.all([loadSuppliers(), populateDropdowns()]);
            } catch (error) {
                console.error('Ошибка добавления поставщика:', error);
                showMessage(`Ошибка добавления поставщика: ${error.message}`, 'error');
            }
        }

        function openEditSupplierModal(supplierId) {
            const supplier = allSuppliers.find(s => s.supplier_id === supplierId);
            if (!supplier) return showMessage('Поставщик не найден.', 'error');

            document.getElementById('editSupplierId').value = supplier.supplier_id;
            // ИСПРАВЛЕНИЕ: отображаем числовой ID
            document.getElementById('editSupplierDisplayId').value = supplier.supplier_id; // Просто числовой ID
            document.getElementById('editSupplierName').value = supplier.supplier_name;
            document.getElementById('editSupplierEmail').value = supplier.email || '';
            document.getElementById('editSupplierPhone').value = supplier.phone;

            const editModal = new bootstrap.Modal(document.getElementById('editSupplierModal'));
            editModal.show();
        }

        async function editSupplier(event) {
            event.preventDefault();
            const supplierData = {
                supplier_id: parseInt(document.getElementById('editSupplierId').value),
                supplier_name: document.getElementById('editSupplierName').value,
                email: document.getElementById('editSupplierEmail').value || null,
                phone: document.getElementById('editSupplierPhone').value,
            };

            try {
                const response = await fetch(`${API_BASE_URL}/supplier`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(supplierData),
                });
                await handleResponse(response, 'Ошибка изменения поставщика');
                showMessage(`Поставщик "${supplierData.supplier_name}" успешно изменен!`, 'success');
                
                bootstrap.Modal.getInstance(document.getElementById('editSupplierModal')).hide();
                await Promise.all([loadSuppliers(), populateDropdowns(), loadProductsWithSuppliers()]);
            } catch (error) {
                console.error('Ошибка изменения поставщика:', error);
                showMessage(`Ошибка изменения поставщика: ${error.message}`, 'error');
            }
        }
        
        async function deleteSupplier(id, name) {
            if (!confirm(`Вы уверены, что хотите удалить поставщика "${name}" (ID: ${id})?`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/supplier?id=${id}`, {
                    method: 'DELETE'
                });
                await handleResponse(response, 'Ошибка удаления поставщика');
                showMessage('Поставщик успешно удален!', 'success');
                await Promise.all([loadSuppliers(), populateDropdowns(), loadProductsWithSuppliers()]);
            } catch (error) {
                console.error('Ошибка удаления поставщика:', error);
                showMessage(`Ошибка удаления поставщика: ${error.message}`, 'error');
            }
        }

        // Склады
        document.getElementById('addStorageForm').addEventListener('submit', addStorage);
        document.getElementById('editStorageForm').addEventListener('submit', editStorage);

        async function addStorage(event) {
            event.preventDefault();
            const storageData = {
                storage_name: document.getElementById('storageName').value,
                address: document.getElementById('storageAddress').value || null,
            };

            try {
                const response = await fetch(`${API_BASE_URL}/storage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(storageData),
                });
                const result = await handleResponse(response, 'Ошибка добавления склада');
                showMessage(`Склад "${storageData.storage_name}" успешно добавлен! (ID: ${result.id})`, 'success');
                
                document.getElementById('addStorageForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addStorageModal')).hide();

                await Promise.all([loadStorages(), populateDropdowns(), loadLeftovers()]);
            } catch (error) {
                console.error('Ошибка добавления склада:', error);
                showMessage(`Ошибка добавления склада: ${error.message}`, 'error');
            }
        }
        
        function openEditStorageModal(storageId) {
            const storage = allStorages.find(s => s.storage_id === storageId);
            if (!storage) return showMessage('Склад не найден.', 'error');

            document.getElementById('editStorageId').value = storage.storage_id;
            document.getElementById('editStorageDisplayId').value = storage.storage_id;
            document.getElementById('editStorageName').value = storage.storage_name;
            document.getElementById('editStorageAddress').value = storage.address || '';

            const editModal = new bootstrap.Modal(document.getElementById('editStorageModal'));
            editModal.show();
        }

        async function editStorage(event) {
            event.preventDefault();
            const storageData = {
                storage_id: parseInt(document.getElementById('editStorageId').value),
                storage_name: document.getElementById('editStorageName').value,
                address: document.getElementById('editStorageAddress').value || null,
            };

            try {
                const response = await fetch(`${API_BASE_URL}/storage`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(storageData),
                });
                await handleResponse(response, 'Ошибка изменения склада');
                showMessage(`Склад "${storageData.storage_name}" успешно изменен!`, 'success');
                
                bootstrap.Modal.getInstance(document.getElementById('editStorageModal')).hide();
                await Promise.all([loadStorages(), loadLeftovers()]);
            } catch (error) {
                console.error('Ошибка изменения склада:', error);
                showMessage(`Ошибка изменения склада: ${error.message}`, 'error');
            }
        }

        async function deleteStorage(id, name) {
            if (!confirm(`Вы уверены, что хотите удалить склад "${name}" (ID: ${id})?`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/storage?id=${id}`, {
                    method: 'DELETE'
                });
                await handleResponse(response, 'Ошибка удаления склада');
                showMessage('Склад успешно удален!', 'success');
                await Promise.all([loadStorages(), populateDropdowns(), loadLeftovers()]);
            } catch (error) {
                console.error('Ошибка удаления склада:', error);
                showMessage(`Ошибка удаления склада: ${error.message}`, 'error');
            }
        }
        
        // Закупки (Остатки на складах)
        document.getElementById('addPurchaseForm').addEventListener('submit', addPurchase);
        document.getElementById('editLeftoverForm').addEventListener('submit', editLeftover);

        async function addPurchase(event) {
            event.preventDefault();
            const purchaseData = {
                product_id: parseInt(document.getElementById('purchaseProduct').value),
                storage_id: parseInt(document.getElementById('purchaseStorage').value),
                leftover: parseInt(document.getElementById('purchaseQuantity').value),
            };

            try {
                const response = await fetch(`${API_BASE_URL}/purchase`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(purchaseData),
                });
                await handleResponse(response, 'Ошибка добавления закупки');
                showMessage(`Закупка успешно добавлена (Кол-во: ${purchaseData.leftover})!`, 'success');
                
                document.getElementById('addPurchaseForm').reset();
                await loadLeftovers();
            } catch (error) {
                console.error('Ошибка добавления закупки:', error);
                showMessage(`Ошибка добавления закупки: ${error.message}`, 'error');
            }
        }
        
        function openEditLeftoverModal(productId, storageId, quantity) {
            document.getElementById('editLeftoverProductId').value = productId;
            document.getElementById('editLeftoverOriginalProductId').value = productId;
            document.getElementById('editLeftoverStorageId').value = storageId;
            document.getElementById('editLeftoverOriginalStorageId').value = storageId;
            document.getElementById('editLeftoverQuantity').value = quantity;
            
            const editModal = new bootstrap.Modal(document.getElementById('editLeftoverModal'));
            editModal.show();
        }

        async function editLeftover(event) {
            event.preventDefault();
            const productIdValue = document.getElementById('editLeftoverProductId').value;
            const storageIdValue = document.getElementById('editLeftoverStorageId').value;
            const quantityValue = document.getElementById('editLeftoverQuantity').value;
            
            const purchase = {
                product_id: parseInt(productIdValue),
                storage_id: parseInt(storageIdValue),
                leftover: parseInt(quantityValue),
            }

            if (isNaN(purchase.product_id) || isNaN(purchase.storage_id) || isNaN(purchase.leftover)) {
                showMessage('Ошибка: Не удалось распознать ID товара, ID склада или количество.', 'error');
                return;
            }

            if(purchase.leftover < 0) {
                showMessage('Ошибка: Остаток не может быть отрицательным.', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/purchase`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(purchase),
                });
                await handleResponse(response, 'Ошибка изменения остатка');
                showMessage('Остаток успешно обновлен!', 'success');
                
                bootstrap.Modal.getInstance(document.getElementById('editLeftoverModal')).hide();
                await loadLeftovers();
            } catch (error) {
                console.error('Ошибка изменения остатка:', error);
                showMessage(`Ошибка изменения остатка: ${error.message}`, 'error');
            }
        }
        
        // НОВОЕ: Удаление Закупки (Остатков)
        async function deleteLeftover(productId, storageId, productName) {
            const productArticle = formatArticle(productId);
            // Получаем имя склада для подтверждения (предполагаем, что allStorages загружен)
            const storage = allStorages.find(s => s.storage_id === storageId);
            const storageName = storage ? storage.storage_name : `Склад ID ${storageId}`;

            if (!confirm(`Вы уверены, что хотите удалить запись об остатках (Закупку) для товара "${productName}" (Артикул: ${productArticle}) со склада "${storageName}"? Это приведет к обнулению остатка.`)) return;

            try {
                // DELETE /purchase?product_id=X&storage_id=Y
                const response = await fetch(`${API_BASE_URL}/purchase?product_id=${productId}&storage_id=${storageId}`, {
                    method: 'DELETE'
                });
                await handleResponse(response, 'Ошибка удаления записи об остатках');
                showMessage(`Запись об остатках для товара "${productName}" со склада "${storageName}" успешно удалена! (Остаток обнулен)`, 'success');
                await loadLeftovers(); // Обновление таблицы
            } catch (error) {
                console.error('Ошибка удаления остатка:', error);
                showMessage(`Ошибка удаления остатка: ${error.message}`, 'error');
            }
        }


        
        // Поставки (связь Товар-Поставщик)
        document.getElementById('addSupplyForm').addEventListener('submit', addSupply);

        async function addSupply(event) {
            event.preventDefault();
            const supplyData = {
                product_id: parseInt(document.getElementById('supplyProduct').value),
                supplier_id: parseInt(document.getElementById('supplySupplierSelect').value),
            };

            try {
                const response = await fetch(`${API_BASE_URL}/supply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(supplyData),
                });
                await handleResponse(response, 'Ошибка добавления поставки');
                showMessage('Поставка успешно добавлена!', 'success');
                
                document.getElementById('addSupplyForm').reset();
                await loadProductsWithSuppliers();
            } catch (error) {
                console.error('Ошибка добавления поставки:', error);
                showMessage(`Ошибка добавления поставки: ${error.message}`, 'error');
            }
        }

        // Удаление Поставки (связь Товар-Поставщик)
        async function deleteSupply(productId, supplierId, productName, supplierName) {
            if (!confirm(`Вы уверены, что хотите удалить поставку для товара "${productName}" от поставщика "${supplierName}"?`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/supply?product_id=${productId}&supplier_id=${supplierId}`, {
                    method: 'DELETE'
                });
                await handleResponse(response, 'Ошибка удаления поставки');
                showMessage('Поставка успешно удалена!', 'success');
                await loadProductsWithSuppliers(); // Обновление таблицы
            } catch (error) {
                console.error('Ошибка удаления поставки:', error);
                showMessage(`Ошибка удаления поставки: ${error.message}`, 'error');
            }
        }
        
        // --- Initialization ---

        function init() {
            // Загрузка данных для всех таблиц и списков при старте
            loadProducts();
            loadSuppliers();
            loadStorages();
            loadLeftovers();
            loadProductsWithSuppliers();
            populateDropdowns();

            // При смене вкладки, принудительно обновляем данные для активной вкладки
            document.getElementById('mainTabs').addEventListener('shown.bs.tab', function (e) {
                const targetId = e.target.getAttribute('href');
                switch(targetId) {
                    case '#nomenclature':
                        loadProducts();
                        break;
                    case '#suppliers':
                        loadSuppliers();
                        break;
                    case '#storages':
                        loadStorages();
                        break;
                    case '#leftovers':
                        loadLeftovers();
                        break;
                    case '#products-suppliers':
                        loadProductsWithSuppliers();
                        break;
                }
            });

            // Обновляем список товаров при смене фильтра
            document.getElementById('supplierFilterSelect').addEventListener('change', loadProducts);
        }

        window.onload = init;
    </script>
</body>
</html>